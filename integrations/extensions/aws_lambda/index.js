"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("express"),t=require("fs"),s=require("url"),r=require("querystring"),i=require("crypto");function n(e){var t=Object.create(null);return e&&Object.keys(e).forEach((function(s){if("default"!==s){var r=Object.getOwnPropertyDescriptor(e,s);Object.defineProperty(t,s,r.get?r:{enumerable:!0,get:function(){return e[s]}})}})),t.default=e,Object.freeze(t)}var o,a,h=n(t),c={},u=function(e){return new d(e)};function d(e){this.capacity=0|e,this.map=Object.create(null),this.list=new p}function p(){this.firstNode=null,this.lastNode=null}function l(e,t){this.key=e,this.val=t,this.prev=null,this.next=null}d.prototype.get=function(e){var t=this.map[e];if(null!=t)return this.used(t),t.val},d.prototype.set=function(e,t){var s=this.map[e];if(null!=s)s.val=t;else{if(this.capacity||this.prune(),!this.capacity)return!1;s=new l(e,t),this.map[e]=s,this.capacity--}return this.used(s),!0},d.prototype.used=function(e){this.list.moveToFront(e)},d.prototype.prune=function(){var e=this.list.pop();null!=e&&(delete this.map[e.key],this.capacity++)},p.prototype.moveToFront=function(e){this.firstNode!=e&&(this.remove(e),null==this.firstNode?(this.firstNode=e,this.lastNode=e,e.prev=null,e.next=null):(e.prev=null,e.next=this.firstNode,e.next.prev=e,this.firstNode=e))},p.prototype.pop=function(){var e=this.lastNode;return null!=e&&this.remove(e),e},p.prototype.remove=function(e){this.firstNode==e?this.firstNode=e.next:null!=e.prev&&(e.prev.next=e.next),this.lastNode==e?this.lastNode=e.prev:null!=e.next&&(e.next.prev=e.prev)},function(e){var t=e,n=s,o=r,a=i,h=u(1e3);function c(e,t,s){return a.createHmac("sha256",e).update(t,"utf8").digest(s)}function d(e,t){return a.createHash("sha256").update(e,"utf8").digest(t)}function p(e){return e.replace(/[!'()*]/g,(function(e){return"%"+e.charCodeAt(0).toString(16).toUpperCase()}))}function l(e){return p(encodeURIComponent(e))}var f={authorization:!0,connection:!0,"x-amzn-trace-id":!0,"user-agent":!0,expect:!0,"presigned-expires":!0,range:!0};function m(e,t){"string"==typeof e&&(e=n.parse(e));var s=e.headers=e.headers||{},r=(!this.service||!this.region)&&this.matchHost(e.hostname||e.host||s.Host||s.host);this.request=e,this.credentials=t||this.defaultCredentials(),this.service=e.service||r[0]||"",this.region=e.region||r[1]||"us-east-1","email"===this.service&&(this.service="ses"),!e.method&&e.body&&(e.method="POST"),s.Host||s.host||(s.Host=e.hostname||e.host||this.createHost(),e.port&&(s.Host+=":"+e.port)),e.hostname||e.host||(e.hostname=s.Host||s.host),this.isCodeCommitGit="codecommit"===this.service&&"GIT"===e.method,this.extraHeadersToIgnore=e.extraHeadersToIgnore||Object.create(null),this.extraHeadersToInclude=e.extraHeadersToInclude||Object.create(null)}m.prototype.matchHost=function(e){var t=((e||"").match(/([^\.]+)\.(?:([^\.]*)\.)?amazonaws\.com(\.cn)?$/)||[]).slice(1,3);if("es"!==t[1]&&"aoss"!==t[1]||(t=t.reverse()),"s3"==t[1])t[0]="s3",t[1]="us-east-1";else for(var s=0;s<2;s++)if(/^s3-/.test(t[s])){t[1]=t[s].slice(3),t[0]="s3";break}return t},m.prototype.isSingleRegion=function(){return["s3","sdb"].indexOf(this.service)>=0&&"us-east-1"===this.region||["cloudfront","ls","route53","iam","importexport","sts"].indexOf(this.service)>=0},m.prototype.createHost=function(){var e=this.isSingleRegion()?"":"."+this.region;return("ses"===this.service?"email":this.service)+e+".amazonaws.com"},m.prototype.prepareRequest=function(){this.parsePath();var e,t=this.request,s=t.headers;t.signQuery?(this.parsedPath.query=e=this.parsedPath.query||{},this.credentials.sessionToken&&(e["X-Amz-Security-Token"]=this.credentials.sessionToken),"s3"!==this.service||e["X-Amz-Expires"]||(e["X-Amz-Expires"]=86400),e["X-Amz-Date"]?this.datetime=e["X-Amz-Date"]:e["X-Amz-Date"]=this.getDateTime(),e["X-Amz-Algorithm"]="AWS4-HMAC-SHA256",e["X-Amz-Credential"]=this.credentials.accessKeyId+"/"+this.credentialString(),e["X-Amz-SignedHeaders"]=this.signedHeaders()):(t.doNotModifyHeaders||this.isCodeCommitGit||(!t.body||s["Content-Type"]||s["content-type"]||(s["Content-Type"]="application/x-www-form-urlencoded; charset=utf-8"),!t.body||s["Content-Length"]||s["content-length"]||(s["Content-Length"]=Buffer.byteLength(t.body)),!this.credentials.sessionToken||s["X-Amz-Security-Token"]||s["x-amz-security-token"]||(s["X-Amz-Security-Token"]=this.credentials.sessionToken),"s3"!==this.service||s["X-Amz-Content-Sha256"]||s["x-amz-content-sha256"]||(s["X-Amz-Content-Sha256"]=d(this.request.body||"","hex")),s["X-Amz-Date"]||s["x-amz-date"]?this.datetime=s["X-Amz-Date"]||s["x-amz-date"]:s["X-Amz-Date"]=this.getDateTime()),delete s.Authorization,delete s.authorization)},m.prototype.sign=function(){return this.parsedPath||this.prepareRequest(),this.request.signQuery?this.parsedPath.query["X-Amz-Signature"]=this.signature():this.request.headers.Authorization=this.authHeader(),this.request.path=this.formatPath(),this.request},m.prototype.getDateTime=function(){if(!this.datetime){var e=this.request.headers,t=new Date(e.Date||e.date||new Date);this.datetime=t.toISOString().replace(/[:\-]|\.\d{3}/g,""),this.isCodeCommitGit&&(this.datetime=this.datetime.slice(0,-1))}return this.datetime},m.prototype.getDate=function(){return this.getDateTime().substr(0,8)},m.prototype.authHeader=function(){return["AWS4-HMAC-SHA256 Credential="+this.credentials.accessKeyId+"/"+this.credentialString(),"SignedHeaders="+this.signedHeaders(),"Signature="+this.signature()].join(", ")},m.prototype.signature=function(){var e,t,s,r=this.getDate(),i=[this.credentials.secretAccessKey,r,this.region,this.service].join(),n=h.get(i);return n||(e=c("AWS4"+this.credentials.secretAccessKey,r),t=c(e,this.region),s=c(t,this.service),n=c(s,"aws4_request"),h.set(i,n)),c(n,this.stringToSign(),"hex")},m.prototype.stringToSign=function(){return["AWS4-HMAC-SHA256",this.getDateTime(),this.credentialString(),d(this.canonicalString(),"hex")].join("\n")},m.prototype.canonicalString=function(){this.parsedPath||this.prepareRequest();var e,t=this.parsedPath.path,s=this.parsedPath.query,r=this.request.headers,i="",n="s3"!==this.service,o="s3"===this.service||this.request.doNotEncodePath,a="s3"===this.service,h="s3"===this.service;if(e="s3"===this.service&&this.request.signQuery?"UNSIGNED-PAYLOAD":this.isCodeCommitGit?"":r["X-Amz-Content-Sha256"]||r["x-amz-content-sha256"]||d(this.request.body||"","hex"),s){var c=Object.keys(s).reduce((function(e,t){return t?(e[l(t)]=Array.isArray(s[t])&&h?s[t][0]:s[t],e):e}),{}),u=[];Object.keys(c).sort().forEach((function(e){Array.isArray(c[e])?c[e].map(l).sort().forEach((function(t){u.push(e+"="+t)})):u.push(e+"="+l(c[e]))})),i=u.join("&")}return"/"!==t&&(n&&(t=t.replace(/\/{2,}/g,"/")),"/"!==(t=t.split("/").reduce((function(e,t){return n&&".."===t?e.pop():n&&"."===t||(o&&(t=decodeURIComponent(t.replace(/\+/g," "))),e.push(l(t))),e}),[]).join("/"))[0]&&(t="/"+t),a&&(t=t.replace(/%2F/g,"/"))),[this.request.method||"GET",t,i,this.canonicalHeaders()+"\n",this.signedHeaders(),e].join("\n")},m.prototype.canonicalHeaders=function(){var e=this.request.headers;return Object.keys(e).filter((function(e){return null==f[e.toLowerCase()]})).sort((function(e,t){return e.toLowerCase()<t.toLowerCase()?-1:1})).map((function(t){return t.toLowerCase()+":"+e[t].toString().trim().replace(/\s+/g," ")})).join("\n")},m.prototype.signedHeaders=function(){var e=this.extraHeadersToInclude,t=this.extraHeadersToIgnore;return Object.keys(this.request.headers).map((function(e){return e.toLowerCase()})).filter((function(s){return e[s]||null==f[s]&&!t[s]})).sort().join(";")},m.prototype.credentialString=function(){return[this.getDate(),this.region,this.service,"aws4_request"].join("/")},m.prototype.defaultCredentials=function(){var e=process.env;return{accessKeyId:e.AWS_ACCESS_KEY_ID||e.AWS_ACCESS_KEY,secretAccessKey:e.AWS_SECRET_ACCESS_KEY||e.AWS_SECRET_KEY,sessionToken:e.AWS_SESSION_TOKEN}},m.prototype.parsePath=function(){var e=this.request.path||"/";/[^0-9A-Za-z;,/?:@&=+$\-_.!~*'()#%]/.test(e)&&(e=encodeURI(decodeURI(e)));var t=e.indexOf("?"),s=null;t>=0&&(s=o.parse(e.slice(t+1)),e=e.slice(0,t)),this.parsedPath={path:e,query:s}},m.prototype.formatPath=function(){var e=this.parsedPath.path,t=this.parsedPath.query;return t?(null!=t[""]&&delete t[""],e+"?"+p(o.stringify(t))):e},t.RequestSigner=m,t.sign=function(e,t){return new m(e,t).sign()}}(c),function(e){e.GRAPHQL="GRAPHQL",e.OPENAPI="OPENAPI"}(o||(o={})),function(e){e.input="input"}(a||(a={}));class f{getAuthHeaders(e){const t=c.sign({service:"lambda",region:e.region,method:e.context.method,path:"/2015-03-31/functions/"},{accessKeyId:"AKIA2QVBJ6HSQW47OAC7",secretAccessKey:"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"});return{Authorization:t.headers.Authorization,"X-Amz-Date":t.headers["X-Amz-Date"],Host:t.headers.Host}}async getSchema(e){return{type:"OPENAPI",schema:JSON.parse(h.readFileSync("./aws_lambda.json","utf8"))}}getSpec(){const e=h.readFileSync("./spec.json","utf8");return JSON.parse(e)}}const m=e();m.use(e.json());m.post("/schema",(async(e,t)=>{const s=new f,r=await s.getSchema(e.body);t.send(r||{})})),m.post("/get_auth_headers",((e,t)=>{const s=new f;t.send(s.getAuthHeaders(e.body)||{})})),m.post("/spec",((e,t)=>{const s=new f;t.send(s.getSpec()||{})})),m.listen(8002,(()=>{console.log("Example app listening on port 8002")})),exports.default=m;
